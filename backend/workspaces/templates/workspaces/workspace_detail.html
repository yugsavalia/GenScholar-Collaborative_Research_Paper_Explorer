{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>{{ workspace.name }}</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        /* (Your existing CSS styles...) */
        body { font-family: Arial; }
        .container { display: flex; gap: 20px; }
        .left-section { flex: 1; min-width: 0; }
        .right-section { width: 300px; flex-shrink: 0; }
        .pdf-viewer { border: 1px solid #ccc; max-height: 600px; width: 100%; display: block; background: #f5f5f5; overflow-y: auto; }
        #pdfCanvas { border: 1px solid #ddd; background: white; display: block; margin: 0 auto; }
        .pdf-controls { text-align: center; margin: 10px 0; }
        .pdf-controls button { padding: 5px 15px; margin: 0 5px; cursor: pointer; }
        #pageInfo { display: inline-block; margin: 0 15px; }
        .chat-box { border: 1px solid #ccc; height: 400px; overflow-y: auto; margin-bottom: 10px; padding: 10px; display: flex; flex-direction: column; }
        .pdf-list { border: 1px solid #ccc; height: 200px; overflow-y: auto; padding: 10px; }
        .pdf-list ul { list-style: none; padding: 0; margin: 0; }
        .pdf-list li { padding: 5px; border-bottom: 1px solid #eee; }
        .pdf-list a { text-decoration: none; color: #0066cc; cursor: pointer; }
        .pdf-list a:hover { text-decoration: underline; }
        .chat-message { padding: 8px 12px; border-radius: 12px; margin-bottom: 10px; max-width: 80%; word-wrap: break-word; line-height: 1.4; background-color: #f1f0f0; color: #333; }
        .message-left { text-align: left; margin-right: auto; }
        .message-right { text-align: left; margin-left: auto; }
        .bot-message { background-color: #e6f7ff; }
        .bot-message strong { color: #0056b3; }
        .chat-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .chat-header h2 { margin: 0; }
        .tab-button { padding: 5px 10px; border: 1px solid #ccc; background: #f9f9f9; cursor: pointer; border-radius: 4px; }
        .tab-button.active { background: #007bff; color: white; border-color: #007bff; }
        .hidden { display: none; }
    </style>
    
    <script>
        window.MathJax = { tex: { inlineMath: [['$', '$']], displayMath: [['$$', '$$']] }, svg: { fontCache: 'global' } };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

</head>
<body>
    <h1>{{ workspace.name }}</h1>
    <p><a href="{% url 'dashboard' %}">Back to Dashboard</a> | <a href="{% url 'logout' %}">Logout</a></p>
    
    <div class="container">
        <div class="left-section">
            <h2>PDFs</h2>
            <form method="post" action="{% url 'upload_pdf' workspace.id %}" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="text" name="title" placeholder="PDF Title" required>
                <input type="file" name="file" accept=".pdf" required>
                <button type="submit">Upload PDF</button>
            </form>
            <form method="GET" action="{% url 'workspace_detail' workspace.id %}" style="margin: 15px 0;">
                <input type="text" name="pdf_q" placeholder="Search PDFs in this workspace..." value="{{ pdf_search_query|default:'' }}">
                <button type="submit">Search</button>
            </form>
            <div class="pdf-list">
                {% if pdf_files %}
                    <ul>
                        {% for pdf in pdf_files %}
                            <li>
                            <a href="#" 
                               data-pdf-url="{% url 'view_pdf' pdf.id %}" 
                               onclick="handlePdfClick(this); return false;">
                               {{ pdf.title }}
                            </a>
                            (Uploaded by {{ pdf.uploaded_by.username }})
                        
                            <form method="POST" action="{% url 'delete_pdf' pdf.id %}" style="display: inline-block; margin-left: 5px;">
                                {% csrf_token %}
                                <button type-="submit" 
                                        onclick="return confirm('Are you sure you want to delete this PDF? This will require re-indexing all other PDFs in the workspace.')"
                                        style="color: red; background: none; border: none; cursor: pointer; padding: 0; font-size: 11px;">
                                    (delete)
                                </button>
                            </form>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}<p>No PDFs uploaded yet.</p>{% endif %}
            </div>
            <h3>PDF Viewer</h3>
            <div class="pdf-viewer">
                <div class="pdf-controls">
                    <button onclick="previousPage()">Previous Page</button>
                    <span id="pageInfo">No PDF loaded</span>
                    <button onclick="nextPage()">Next Page</button>
                </div>
                <canvas id="pdfCanvas" width="800" height="200"></canvas>
            </div>
        </div>
        
        <div class="right-section">
            <div class="chat-header">
                <button id="btn-main-chat" class="tab-button active">Main Chat</button>
                <button id="btn-ai-chat" class="tab-button">AI Assistance</button>
            </div>
            <p id="connection-status" style="font-size: 12px; color: gray;">Connecting...</p>
            
            <div id="main-chat-container">
                <div id="main-chat-messages" class="chat-box">
                    {% for message in messages %}
                        <div class="chat-message {% if message.user == request.user %}message-right{% else %}message-left{% endif %}">
                            <strong>{{ message.user.username }}</strong><br>
                            {{ message.message }}
                        </div>
                    {% endfor %}
                </div>
                <form id="main-chat-form">
                    {% csrf_token %}
                    <input type="text" id="main-chat-input" placeholder="Type a message..." required>
                    <button type="submit">Send</button>
                </form>
            </div>

            <div id="ai-chat-container" class="hidden">
                <div id="ai-chat-messages" class="chat-box">
                    {% for message in ai_messages %}
                        <div class="chat-message 
                            {% if message.is_from_bot %}bot-message message-left{% else %}message-right{% endif %}">
                            <strong>{% if message.is_from_bot %}AI_Bot{% else %}{{ message.user.username }}{% endif %}</strong>
                            <br>
                            {{ message.message }}
                        </div>
                    {% endfor %}
                </div>
                <form id="ai-chat-form">
                    {% csrf_token %}
                    <input type="text" id="ai-chat-input" placeholder="Ask the AI..." required>
                    <button type="submit">Send</button>
                </form>
            </div>

            <h3>Members</h3>
            <ul>{% for member in members %}<li>{{ member.user.username }}</li>{% endfor %}</ul>
            <h3>Invite User</h3>
            {% if available_users %}
                <form method="post" action="{% url 'invite_to_workspace' workspace.id %}">
                    {% csrf_token %}
                    <select name="username" required>
                        <option value="">Select a user...</option>
                        {% for user in available_users %}<option value="{{ user.username }}">{{ user.username }}</option>{% endfor %}
                    </select>
                    <button type="submit">Invite</button>
                </form>
            {% else %}<p>All users are already members of this workspace.</p>{% endif %}
        </div>
    </div>
    
    <script>
        // (PDF.js functions - Unchanged)
        let currentPdf = null, currentPage = 1, pdfPages = 0;
        async function loadPDF(url) { /* ... same as before ... */ 
            try {
                const canvas = document.getElementById('pdfCanvas');
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#f0f0f0';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#333';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Loading PDF...', canvas.width / 2, canvas.height / 2);
                const loadingTask = pdfjsLib.getDocument(url);
                currentPdf = await loadingTask.promise;
                pdfPages = currentPdf.numPages;
                currentPage = 1;
                await renderPage(currentPage);
                document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${pdfPages}`;
            } catch (error) {
                console.error('Error loading PDF:', error);
                alert('Failed to load PDF');
            }
        }
        async function renderPage(pageNum) { /* ... same as before ... */ 
            if (!currentPdf || pageNum < 1 || pageNum > pdfPages) return;
            const canvas = document.getElementById('pdfCanvas');
            const ctx = canvas.getContext('2d');
            try {
                const page = await currentPdf.getPage(pageNum);
                const viewport = page.getViewport({ scale: 1.5 });
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                await page.render({ canvasContext: ctx, viewport: viewport }).promise;
            } catch (error) {
                console.error('Error rendering page:', error);
            }
        }
        function previousPage() { /* ... same as before ... */ 
            if (currentPage > 1) {
                currentPage--;
                renderPage(currentPage);
                document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${pdfPages}`;
            }
        }
        function nextPage() { /* ... same as before ... */ 
            if (currentPage < pdfPages) {
                currentPage++;
                renderPage(currentPage);
                document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${pdfPages}`;
            }
        }
        function handlePdfClick(element) { /* ... same as before ... */ 
            const pdfUrl = element.getAttribute('data-pdf-url');
            document.querySelectorAll('.pdf-list a').forEach(a => a.style.fontWeight = 'normal');
            element.style.fontWeight = 'bold';
            loadPDF(pdfUrl);
        }

        // --- Get references to all chat elements ---
        const mainChatContainer = document.getElementById('main-chat-container');
        const mainChatMessages = document.getElementById('main-chat-messages');
        const mainChatInput = document.getElementById('main-chat-input');
        
        const aiChatContainer = document.getElementById('ai-chat-container');
        const aiChatMessages = document.getElementById('ai-chat-messages');
        const aiChatInput = document.getElementById('ai-chat-input');

        const btnMainChat = document.getElementById('btn-main-chat');
        const btnAiChat = document.getElementById('btn-ai-chat');

        const connectionStatus = document.getElementById('connection-status');
        
        const csrfToken = document.querySelector('#main-chat-form input[name="csrfmiddlewaretoken"]').value;
        const workspaceId = {{ workspace.id }};
        const currentUserUsername = "{{ request.user.username|escapejs }}";

        
        // --- *** UPDATED: AI API Function *** ---
        // Now appends the Q&A to the AI chat box manually
        async function askAiBot(questionText) {
            // Optimistically add the user's question to the chat
            appendMessage(currentUserUsername, questionText, aiChatMessages);

            try {
                const response = await fetch('/api/chatbot/ask/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify({
                        'question': questionText,
                        'workspace_id': workspaceId
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    console.error('Chatbot API Error:', data.error);
                    appendMessage('AI_Bot', `Error: ${data.error}`, aiChatMessages);
                } else {
                    // --- NEW: Add the AI's answer ---
                    // The backend returns the answer, so we add it here.
                    appendMessage('AI_Bot', data.ai_answer, aiChatMessages);
                }
            } catch (error) {
                console.error('Chatbot fetch Error:', error);
                appendMessage('AI_Bot', 'Sorry, a connection error occurred.', aiChatMessages);
            }
        }
        
        // --- appendMessage function (with MathJax) ---
        function appendMessage(username, message, chatBox) {
            const messageElement = document.createElement('div');
            messageElement.className = 'chat-message';
            
            if (username === currentUserUsername) {
                messageElement.classList.add('message-right');
            } else {
                messageElement.classList.add('message-left');
            }
            
            if (username === 'AI_Bot') {
                messageElement.classList.add('bot-message');
            }
            
            messageElement.innerHTML = `<strong>${username}</strong><br>${message}`;
            chatBox.appendChild(messageElement);
            
            if (window.MathJax && (username === 'AI_Bot' || message.includes('$'))) {
                try {
                    MathJax.typesetPromise([messageElement]).catch((err) => console.log('MathJax error:', err));
                } catch(e) {
                    console.error("Error typesetting MathJax:", e);
                }
            }
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // --- WebSocket Setup ---
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const chatSocket = new WebSocket(
            wsProtocol + '//' + window.location.host + '/ws/chat/' + workspaceId + '/'
        );
        
        chatSocket.onopen = function(e) { /* ... same as before ... */ 
            console.log('WebSocket connected');
            connectionStatus.textContent = 'Connected';
            connectionStatus.style.color = 'green';
            mainChatMessages.scrollTop = mainChatMessages.scrollHeight;
            aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
        };
        chatSocket.onerror = function(error) { /* ... same as before ... */ 
            console.error('WebSocket error:', error);
            connectionStatus.textContent = 'Connection error - Make sure server is running with Daphne';
            connectionStatus.style.color = 'red';
        };
        chatSocket.onclose = function(e) { /* ... same as before ... */ 
            console.log('WebSocket closed');
            connectionStatus.textContent = 'Disconnected';
            connectionStatus.style.color = 'red';
        };
        
        // --- *** UPDATED: onmessage *** ---
        // Now *only* handles public main chat
        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            
            // This now ONLY handles human messages.
            if (data.username !== 'AI_Bot' && !data.message.startsWith('/ai')) {
                appendMessage(data.username, data.message, mainChatMessages);
            }
        };
        
        // --- Form handler for MAIN CHAT (Unchanged) ---
        document.getElementById('main-chat-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const message = mainChatInput.value;
            if (!message.trim()) return;

            if (chatSocket.readyState === WebSocket.OPEN) {
                chatSocket.send(JSON.stringify({ 'message': message }));
            } else {
                alert('WebSocket is not connected. Please refresh the page.');
            }
            mainChatInput.value = '';
        });

        // --- Form handler for AI CHAT (Unchanged) ---
        document.getElementById('ai-chat-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const message = aiChatInput.value;
            if (!message.trim()) return;
            const aiQuestion = '/ai ' + message; 
            askAiBot(aiQuestion);
            aiChatInput.value = '';
        });

        // --- Tab Switching Logic (Unchanged) ---
        btnMainChat.addEventListener('click', () => {
            mainChatContainer.classList.remove('hidden');
            aiChatContainer.classList.add('hidden');
            btnMainChat.classList.add('active');
            btnAiChat.classList.remove('active');
        });

        btnAiChat.addEventListener('click', () => {
            mainChatContainer.classList.add('hidden');
            aiChatContainer.classList.remove('hidden');
            btnMainChat.classList.remove('active');
            btnAiChat.classList.add('active');
        });

    </script>
</body>
</html>